<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Asolvi Customers App</title>
</head>

<body>
    <button id="get">Get</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/7.0.0/polyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.0.0/dist/fetch.umd.min.js"></script>
    <script src="https://cdn.auth0.com/js/auth0/9.5.1/auth0.min.js"></script>
    <script>
        (function () {
            'use strict';
            const config = require("./config.json");
            const CLIENT_ID = config.CLIENT_ID;
            const API_AUDIENCE = config.API_AUDIENCE;
            const AUTH0_DOMAIN = config.AUTH0_DOMAIN;
            const REDIRECT_URI = config.REDIRECT_URI;

            var auth0 = new window.auth0.WebAuth({
                clientID: CLIENT_ID,
                domain: AUTH0_DOMAIN,
                responseType: 'token id_token',
                audience: API_AUDIENCE,
                redirectUri: REDIRECT_URI,
                scope: 'openid profile',
            });
            var hash = window.location.hash;
            if (hash === '') {
                auth0.authorize();
                return
            }
            auth0.parseHash(handleParseHash);
            function handleParseHash(err, authResult) {
                var accessToken;
                var idToken;
                if (authResult && authResult.accessToken && authResult.idToken) {
                    accessToken = authResult.accessToken;
                    idToken = authResult.idToken;
                    window.console.log(idToken);
                    auth0.client.userInfo(accessToken, handleUserInfo);
                    enableButton();
                    function handleUserInfo(userErr, user) {
                        if (userErr) {
                            return;
                        }
                        window.console.log(user);
                    }
                } else {
                    window.console.log('ERROR');
                }
                function enableButton() {
                    var buttonEl = document.getElementById('get');
                    buttonEl.addEventListener('click', handleClick);
                    function handleClick() {
                        window.fetch(apiIdentifier, {
                            headers: {
                                Authorization: 'Bearer ' + accessToken
                            },
                        })
                            .then(handleSuccess)
                            .then(handleJSON)
                            .catch(handleError);
                        function handleSuccess(response) {
                            return response.json();
                        }
                        function handleJSON(json) {
                            window.console.log(json);
                        }
                        function handleError(err) {
                            window.console.log(err);
                        }
                    }
                }
            }
        })();
    </script>
</body>

</html>