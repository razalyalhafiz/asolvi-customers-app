<!-- views/pages/index.ejs -->

<!DOCTYPE html>
<html lang="en">

<head>
    <% include ./partials/head %>
</head>

<body class="container">

    <header>
        <% include ./partials/header %>
    </header>
    
    <main>
        <div class="container">
            <div class="jumbotron">
                <h2>Customers</h2>
            </div>

            <div class="row">
                <% customers.forEach(function(customer, index) { %>
                    <div class="col-sm-4">
                        <div class="panel">
                            <div class="panel-heading">
                                <h3 class="panel-title"><%= customer.name %></h3>
                            </div>
                            <div class="panel-body text-center">
                                <img class="img-circle" src="<%= customer.avatar %>" />
                            </div>
                            <div class="panel-footer small">
                                <p><%= customer.status %></p>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
    </main>
    
    <footer>
        <% include ./partials/footer %>
    </footer>

    <script>
        (function () {
            'use strict';
            const ENDPOINT = 'https://asolvi-customers-api.herokuapp.com';

            var auth0 = new window.auth0.WebAuth({
                clientID: 'OPEBMU2ClhWLFYo7JWDXzS0S3GzM9Oax',
                domain: 'razalyalhafiz.au.auth0.com',
                responseType: 'token id_token',
                audience: 'https://asolvi-customers-api.herokuapp.com',
                redirectUri: 'https://asolvi-customers-app.herokuapp.com',
                scope: 'openid profile',
            });

            var hash = location.hash;
            if (hash === '') {
                auth0.authorize();
                return
            }
            auth0.parseHash(handleParseHash);

            function handleParseHash(err, authResult) {
                var accessToken;
                var idToken;
                if (authResult && authResult.accessToken && authResult.idToken) {
                    accessToken = authResult.accessToken;
                    idToken = authResult.idToken;
                    console.log(idToken);
                    auth0.client.userInfo(accessToken, handleUserInfo);
                    enableButton();

                    function handleUserInfo(userErr, user) {
                        if (userErr) {
                            return;
                        }
                        console.log(user);
                    }
                } else {
                    console.log('ERROR');
                }

                function enableButton() {
                    var buttonEl = document.getElementById('get');
                    buttonEl.addEventListener('click', handleClick);
                    
                    function handleClick() {
                        fetch(ENDPOINT, {
                            headers: {
                                Authorization: 'Bearer ' + accessToken
                            },
                        })
                        .then(handleSuccess)
                        .then(handleJSON)
                        .catch(handleError);

                        function handleSuccess(response) {
                            return response.json();
                        }

                        function handleJSON(json) {
                            var customers = json;
                            console.log(customers);
                        }

                        function handleError(err) {
                            console.log(err);
                        }
                    }
                }
            }
        })();
    </script>
</body>

</html>