function _extractManagementAPIToken(casper, test) {
  casper.thenOpen("https://manage.auth0.com/#/apis", function () {
    casper.echo("Extracting the Management API token");
    casper.waitForUrl("https://manage.auth0.com/#/apis", null, null, 10000);
    casper.waitUntilVisible("#api .howto .btn.btn-success",
      function success() {
        this.capture('screenshots/API/00.png');
        //Dismiss the notice
        this.click("#api .howto .btn.btn-success");
      },
      function timeout() {
        this.echo("API Features notice never showed up.");
      }, 5000);
    casper.waitUntilVisible("#api .api-item .api-title .action-settings", function () {
      this.capture('screenshots/API/01.png');
      this.clickLabel("Auth0 Management API");
    }, null, 5000);
    casper.waitUntilVisible("#api-settings .nav.nav-tabs.api-nav .api-explorer-tab .js-app-tabroute", function () {
      this.capture('screenshots/API/02.png');
      this.click("#api-settings .nav.nav-tabs.api-nav .api-explorer-tab .js-app-tabroute");
    }, null, 10000);
    casper.waitUntilVisible("#api-explorer #regenerate-test-client .btn.btn-primary",
      function success() {
        //Generate a new API Explorer client
        this.click("#api-explorer #regenerate-test-client .btn.btn-primary");
      },
      function timeout() {
        this.echo("API already has a API Explorer client. [This shouldn't happen]");
      }, 5000);
    casper.waitUntilVisible("#api-explorer .pre-explorer-cont.clearfix code", function () {
      this.echo("Renewing the API token..");
      this.capture('screenshots/API/03.png');
      this.click("#api-explorer #token-form .btn.btn-primary.save-token-lifetime");
    }, null, 10000);
    casper.waitWhileVisible("#api-explorer #token-form .btn.btn-primary.save-token-lifetime.disabled", function () {
      this.capture('screenshots/API/04.png');
      mgmtToken = this.getHTML("#api-explorer .pre-explorer-cont.clearfix code");
      console.log("[Auth0.Token]=" + mgmtToken);
    }, null, 10000);
  });
}

function _extractAuth0ManageCookie(casper, test) {
  casper.then(function () {
    var cookies = casper.page.cookies;
    for (var i in cookies) {
      if (cookies[i].name === 'auth0l') {
        console.log("[Auth0.Cookie]=" + cookies[i].name + '=' + cookies[i].value);
      }
    }
  });
}

function _extractData(casper, test) {
  _extractManagementAPIToken(casper, test);
  _extractAuth0ManageCookie(casper, test);
}

module.exports = _extractData;
